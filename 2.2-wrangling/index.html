<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="" xml:lang="">
  <head>
    <title>Data manipulation with dplyr, purrr and broom</title>
    <meta charset="utf-8" />
    <meta name="author" content="Di Cook (dicook@monash.edu, @visnut)   Heike Hofmann (heike.hofmann@gmail.com, @heike_hh)" />
    <link href="index_files/remark-css-0.0.1/default.css" rel="stylesheet" />
    <script src="index_files/htmlwidgets-1.3/htmlwidgets.js"></script>
    <script src="index_files/plotly-binding-4.9.0/plotly.js"></script>
    <script src="index_files/typedarray-0.1/typedarray.min.js"></script>
    <script src="index_files/jquery-1.11.3/jquery.min.js"></script>
    <link href="index_files/crosstalk-1.0.0/css/crosstalk.css" rel="stylesheet" />
    <script src="index_files/crosstalk-1.0.0/js/crosstalk.min.js"></script>
    <link href="index_files/plotly-htmlwidgets-css-1.46.1/plotly-htmlwidgets.css" rel="stylesheet" />
    <script src="index_files/plotly-main-1.46.1/plotly-latest.min.js"></script>
    <link rel="stylesheet" href="myremark.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, inverse, title-slide

# Data manipulation with dplyr, purrr and broom
## SISBID 2019 <br> <a href="https://github.com/dicook/SISBID" class="uri">https://github.com/dicook/SISBID</a>
### Di Cook (<a href="mailto:dicook@monash.edu" class="email">dicook@monash.edu</a>, <span class="citation">@visnut</span>) <br> Heike Hofmann (<a href="mailto:heike.hofmann@gmail.com" class="email">heike.hofmann@gmail.com</a>, <span class="citation">@heike_hh</span>)
### 07/24-26/2019

---







# Outline

- `dplyr` package: motivation, functions, chaining
- `purrr`: working with list variables, vectors of data frames

---
# dplyr verbs

There are five primary dplyr **verbs**, representing distinct data analysis tasks:

- `filter`: Remove the rows of a data frame, producing subsets
- `arrange`: Reorder the rows of a data frame
- `select`: Select particular columns of a data frame
- `mutate`: Add new columns that are functions of existing columns
- `summarise`: Create collapsed summaries of a data frame
- (`group_by`: Introduce structure to a data frame)
 
 
---
# Filter

select a subset of the observations (horizontal selection)

```r
load(here::here("data/french_fries.rda"))
french_fries %&gt;%
    filter(subject == 3, time == 1)
# A tibble: 6 x 9
  time  treatment subject   rep potato buttery grassy rancid painty
  &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 1     1         3           1    2.9     0      0      0      5.5
2 1     1         3           2   14       0      0      1.1    0  
3 1     2         3           1   13.9     0      0      3.9    0  
4 1     2         3           2   13.4     0.1    0      1.5    0  
5 1     3         3           1   14.1     0      0      1.1    0  
6 1     3         3           2    9.5     0      0.6    2.8    0  
```

---
# Arrange

order the observations (hierarchically)

```r
french_fries %&gt;%
    arrange(desc(rancid)) %&gt;%
    head
# A tibble: 6 x 9
  time  treatment subject   rep potato buttery grassy rancid painty
  &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;   &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;  &lt;dbl&gt;
1 9     2         51          1    7.3     2.3      0   14.9    0.1
2 10    1         86          2    0.7     0        0   14.3   13.1
3 5     2         63          1    4.4     0        0   13.8    0.6
4 9     2         63          1    1.8     0        0   13.7   12.3
5 5     2         19          2    5.5     4.7      0   13.4    4.6
6 4     3         63          1    5.6     0        0   13.3    4.4
```

---
# Select

select a subset of the variables (vertical selection)

```r
french_fries %&gt;%
    select(time, treatment, subject, rep, potato) %&gt;%
    head
# A tibble: 6 x 5
  time  treatment subject   rep potato
  &lt;fct&gt; &lt;fct&gt;     &lt;fct&gt;   &lt;dbl&gt;  &lt;dbl&gt;
1 1     1         3           1    2.9
2 1     1         3           2   14  
3 1     1         10          1   11  
4 1     1         10          2    9.9
5 1     1         15          1    1.2
6 1     1         15          2    8.8
```

---
# Summarise

summarize observations into a (set of) one-number statistic(s):

```r
french_fries %&gt;%
    summarise(mean_rancid = mean(rancid, na.rm=TRUE), 
              sd_rancid = sd(rancid, na.rm = TRUE))
# A tibble: 1 x 2
  mean_rancid sd_rancid
        &lt;dbl&gt;     &lt;dbl&gt;
1        3.85      3.78
```

---
# Summarise and Group_by


```r
french_fries %&gt;%
    group_by(time, treatment) %&gt;%
    summarise(mean_rancid = mean(rancid), sd_rancid = sd(rancid))
# A tibble: 30 x 4
# Groups:   time [10]
   time  treatment mean_rancid sd_rancid
   &lt;fct&gt; &lt;fct&gt;           &lt;dbl&gt;     &lt;dbl&gt;
 1 1     1                2.76      3.21
 2 1     2                1.72      2.71
 3 1     3                2.6       3.20
 4 2     1                3.9       4.37
 5 2     2                2.14      3.12
 6 2     3                2.50      3.38
 7 3     1                4.65      3.93
 8 3     2                2.90      3.77
 9 3     3                3.6       3.59
10 4     1                2.08      2.39
# … with 20 more rows
```



---
# Let's use these tools

to answer these french fry experiment questions:

- Is the design complete?
- Are replicates like each other? 
- How do the ratings on the different scales differ?
- Are raters giving different scores on average?
- Do ratings change over the weeks?

---
# Completeness 
If the data is complete it should be 12 x 10 x 3 x 2, that is, 6 records for each person. (Assuming that each person rated on all scales.) 

To check this we want to tabulate the number of records for each subject, time and treatment. This means select appropriate columns, tabulate, count and spread it out to give a nice table.

---
class: inverse middle 
# Your turn

How many values do we have for each subject? Check the help for function `?n`



---
# French Fries - completeness

`n()`


```r
french_fries %&gt;% 
  group_by(subject) %&gt;% 
  summarize(n = n()) 
# A tibble: 12 x 2
   subject     n
   &lt;fct&gt;   &lt;int&gt;
 1 3          54
 2 10         60
 3 15         60
 4 16         60
 5 19         60
 6 31         54
 7 51         60
 8 52         60
 9 63         60
10 78         60
11 79         54
12 86         54
```

---
# Other nice short cuts 

instead of `group_by(subject) %&gt;% summarize(n = n())` we can use:

- `group_by(subject) %&gt;% tally()`
- `count(subject)`

---
# Counts for subject by time


```r
french_fries %&gt;% 
  na.omit() %&gt;%
  count(subject, time) %&gt;%
  spread(time, n)
# A tibble: 12 x 11
   subject   `1`   `2`   `3`   `4`   `5`   `6`   `7`   `8`   `9`  `10`
   &lt;fct&gt;   &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
 1 3           6     6     6     6     6     6     6     6     6    NA
 2 10          6     6     6     6     6     6     6     6     6     6
 3 15          6     6     6     6     5     6     6     6     6     6
 4 16          6     6     6     6     6     6     6     5     6     6
 5 19          6     6     6     6     6     6     6     6     6     6
 6 31          6     6     6     6     6     6     6     6    NA     6
 7 51          6     6     6     6     6     6     6     6     6     6
 8 52          6     6     6     6     6     6     6     6     6     6
 9 63          6     6     6     6     6     6     6     6     6     6
10 78          6     6     6     6     6     6     6     6     6     6
11 79          6     6     6     6     6     6     5     4     6    NA
12 86          6     6     6     6     6     6     6     6    NA     6
```


---
# How do scores change over time?


```r
ff.m &lt;- french_fries %&gt;% 
  gather(type, rating, -subject, -time, -treatment, -rep)
ggplot(data=ff.m, aes(x=time, y=rating, colour=treatment)) +
  geom_point() +
  facet_grid(subject~type) 
```

---


&lt;img src="index_files/figure-html/unnamed-chunk-11-1.png" style="display: block; margin: auto;" /&gt;

very messy!

---
# Get means over reps, and connect the dots


```r
ff.m.av &lt;- ff.m %&gt;% 
  group_by(subject, time, type, treatment) %&gt;%
  summarise(rating=mean(rating))

ggplot(data=ff.m, aes(x=time, y=rating, colour=treatment)) + 
  facet_grid(subject~type) +
  geom_line(data=ff.m.av, aes(group=treatment))
```

---

&lt;img src="index_files/figure-html/unnamed-chunk-13-1.png" style="display: block; margin: auto;" /&gt;

---
# Working with lots of models

Why would we even do that?

- Hans Rosling can explain that really well in his [TED talk](https://www.ted.com/talks/hans_rosling_shows_the_best_stats_you_ve_ever_seen?language=en)
- [gapminder project](https://www.gapminder.org/)
- gapminder also makes data available (in R through the package `gapminder`)

---
# First Look


```r
ggplot(data=gapminder, 
       aes(x=year, y=lifeExp, group=country)) + 
  geom_line()
```

&lt;img src="index_files/figure-html/unnamed-chunk-14-1.png" style="display: block; margin: auto;" /&gt;

How would you describe this plot?

---
# First Look


```r
library(gapminder)
ggplot(data=gapminder, 
       aes(x=year, y=lifeExp, group=country, colour=continent)) + 
  geom_line()
```

&lt;img src="index_files/figure-html/unnamed-chunk-15-1.png" style="display: block; margin: auto;" /&gt;

How about now?

---
# Using models as exploratory tools

- Idea: fit a line to each one of the countries life expectancies
- then use e.g. intercept and slope to characterise groups of countries

<div id="htmlwidget-41e1db7eeb79e01cbfa0" style="width:468px;height:360px;" class="plotly html-widget"></div>
<script type="application/json" data-for="htmlwidget-41e1db7eeb79e01cbfa0">{"x":{"data":[{"x":[42.2364149184149,31.7079741258741,38.9200470862471,52.8077783216784,33.9567426573427,40.2703724941725,40.7491678321679,38.4417016317017,39.3028836829837,39.0952181818182,41.7732461538462,46.7465904428905,44.5847456876457,35.5423468531469,39.8570909090909,33.8099664335664,34.9458888111888,35.4137832167832,38.0418804195804,27.2367200466201,42.8492582750583,30.7073256410257,31.1935321678322,46.5890230769231,47.1878941724942,39.6444356643357,40.8508645687646,35.8606081585082,36.4419200466201,32.2976111888112,39.1327675990676,54.6738615384616,41.6058878787879,33.7571832167832,46.6720060606061,34.4664484848485,37.4433941724942,53.0777776223777,42.8336116550117,47.8461990675991,35.7372666666667,30.4551351981352,34.2162505827506,49.0029631701632,37.1086426573426,46.1977093240093,42.759034032634,40.2122769230769,43.379620979021,44.0320459207459,47.778875990676,55.4072855477856],"y":[0.56927972027972,0.20933986013986,0.334232867132867,0.0606685314685308,0.363974825174825,0.154134265734266,0.250146853146853,0.183905594405594,0.253244055944055,0.450390909090909,0.0939153846153843,0.195095804195804,0.130556643356643,0.367403496503496,0.555454545454545,0.310170629370629,0.37469020979021,0.307185314685314,0.446732867132867,0.581825874125873,0.321742657342657,0.424830769230769,0.271753146853147,0.206507692307692,0.0955657342657339,0.0959937062937062,0.625535664335664,0.403727972027972,0.234225874125874,0.37680979020979,0.446417482517482,0.348453846153846,0.542472727272727,0.224485314685315,0.231163636363636,0.34210909090909,0.208065734265734,0.459880419580419,-0.0458314685314688,0.340682517482517,0.504699999999999,0.214034965034965,0.229573426573426,0.16915944055944,0.382774825174825,0.0950748251748249,0.174688111888112,0.382592307692307,0.587843356643356,0.121586013986014,-0.0604251748251749,-0.0930209790209793],"text":["(Intercept): 42.23641<br />year:  0.56927972<br />continent: Africa<br />country: Algeria","(Intercept): 31.70797<br />year:  0.20933986<br />continent: Africa<br />country: Angola","(Intercept): 38.92005<br />year:  0.33423287<br />continent: Africa<br />country: Benin","(Intercept): 52.80778<br />year:  0.06066853<br />continent: Africa<br />country: Botswana","(Intercept): 33.95674<br />year:  0.36397483<br />continent: Africa<br />country: Burkina Faso","(Intercept): 40.27037<br />year:  0.15413427<br />continent: Africa<br />country: Burundi","(Intercept): 40.74917<br />year:  0.25014685<br />continent: Africa<br />country: Cameroon","(Intercept): 38.44170<br />year:  0.18390559<br />continent: Africa<br />country: Central African Republic","(Intercept): 39.30288<br />year:  0.25324406<br />continent: Africa<br />country: Chad","(Intercept): 39.09522<br />year:  0.45039091<br />continent: Africa<br />country: Comoros","(Intercept): 41.77325<br />year:  0.09391538<br />continent: Africa<br />country: Congo, Dem. Rep.","(Intercept): 46.74659<br />year:  0.19509580<br />continent: Africa<br />country: Congo, Rep.","(Intercept): 44.58475<br />year:  0.13055664<br />continent: Africa<br />country: Cote d'Ivoire","(Intercept): 35.54235<br />year:  0.36740350<br />continent: Africa<br />country: Djibouti","(Intercept): 39.85709<br />year:  0.55545455<br />continent: Africa<br />country: Egypt","(Intercept): 33.80997<br />year:  0.31017063<br />continent: Africa<br />country: Equatorial Guinea","(Intercept): 34.94589<br />year:  0.37469021<br />continent: Africa<br />country: Eritrea","(Intercept): 35.41378<br />year:  0.30718531<br />continent: Africa<br />country: Ethiopia","(Intercept): 38.04188<br />year:  0.44673287<br />continent: Africa<br />country: Gabon","(Intercept): 27.23672<br />year:  0.58182587<br />continent: Africa<br />country: Gambia","(Intercept): 42.84926<br />year:  0.32174266<br />continent: Africa<br />country: Ghana","(Intercept): 30.70733<br />year:  0.42483077<br />continent: Africa<br />country: Guinea","(Intercept): 31.19353<br />year:  0.27175315<br />continent: Africa<br />country: Guinea-Bissau","(Intercept): 46.58902<br />year:  0.20650769<br />continent: Africa<br />country: Kenya","(Intercept): 47.18789<br />year:  0.09556573<br />continent: Africa<br />country: Lesotho","(Intercept): 39.64444<br />year:  0.09599371<br />continent: Africa<br />country: Liberia","(Intercept): 40.85086<br />year:  0.62553566<br />continent: Africa<br />country: Libya","(Intercept): 35.86061<br />year:  0.40372797<br />continent: Africa<br />country: Madagascar","(Intercept): 36.44192<br />year:  0.23422587<br />continent: Africa<br />country: Malawi","(Intercept): 32.29761<br />year:  0.37680979<br />continent: Africa<br />country: Mali","(Intercept): 39.13277<br />year:  0.44641748<br />continent: Africa<br />country: Mauritania","(Intercept): 54.67386<br />year:  0.34845385<br />continent: Africa<br />country: Mauritius","(Intercept): 41.60589<br />year:  0.54247273<br />continent: Africa<br />country: Morocco","(Intercept): 33.75718<br />year:  0.22448531<br />continent: Africa<br />country: Mozambique","(Intercept): 46.67201<br />year:  0.23116364<br />continent: Africa<br />country: Namibia","(Intercept): 34.46645<br />year:  0.34210909<br />continent: Africa<br />country: Niger","(Intercept): 37.44339<br />year:  0.20806573<br />continent: Africa<br />country: Nigeria","(Intercept): 53.07778<br />year:  0.45988042<br />continent: Africa<br />country: Reunion","(Intercept): 42.83361<br />year: -0.04583147<br />continent: Africa<br />country: Rwanda","(Intercept): 47.84620<br />year:  0.34068252<br />continent: Africa<br />country: Sao Tome and Principe","(Intercept): 35.73727<br />year:  0.50470000<br />continent: Africa<br />country: Senegal","(Intercept): 30.45514<br />year:  0.21403497<br />continent: Africa<br />country: Sierra Leone","(Intercept): 34.21625<br />year:  0.22957343<br />continent: Africa<br />country: Somalia","(Intercept): 49.00296<br />year:  0.16915944<br />continent: Africa<br />country: South Africa","(Intercept): 37.10864<br />year:  0.38277483<br />continent: Africa<br />country: Sudan","(Intercept): 46.19771<br />year:  0.09507483<br />continent: Africa<br />country: Swaziland","(Intercept): 42.75903<br />year:  0.17468811<br />continent: Africa<br />country: Tanzania","(Intercept): 40.21228<br />year:  0.38259231<br />continent: Africa<br />country: Togo","(Intercept): 43.37962<br />year:  0.58784336<br />continent: Africa<br />country: Tunisia","(Intercept): 44.03205<br />year:  0.12158601<br />continent: Africa<br />country: Uganda","(Intercept): 47.77888<br />year: -0.06042517<br />continent: Africa<br />country: Zambia","(Intercept): 55.40729<br />year: -0.09302098<br />continent: Africa<br />country: Zimbabwe"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(27,158,119,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(27,158,119,1)"}},"hoveron":"points","name":"Africa","legendgroup":"Africa","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[62.2250191142191,37.7565843822844,50.7318594405595,68.4461076923077,53.364017016317,52.6656146853147,58.2991261072261,61.571148018648,47.6555027972028,48.0652655011655,45.5576662004662,41.0568505827506,38.4520377622378,41.9067067599068,62.2181983682984,52.1033018648019,41.9320890442891,57.3525818181818,62.1671242424243,43.2922452214453,66.527375990676,61.7049846153846,68.0455076923077,65.3750585081585,56.8538771561772],"y":[0.231708391608391,0.499932167832167,0.39008951048951,0.21886923076923,0.476844055944055,0.380750349650349,0.40278951048951,0.321150349650349,0.471152447552447,0.500053146853146,0.477141258741258,0.531273426573426,0.397058041958041,0.542851748251748,0.221394405594405,0.451034965034965,0.55651958041958,0.354209090909091,0.157354545454545,0.527697902097902,0.210574825174824,0.173661538461538,0.184169230769231,0.183272027972027,0.329721678321678],"text":["(Intercept): 62.22502<br />year:  0.23170839<br />continent: Americas<br />country: Argentina","(Intercept): 37.75658<br />year:  0.49993217<br />continent: Americas<br />country: Bolivia","(Intercept): 50.73186<br />year:  0.39008951<br />continent: Americas<br />country: Brazil","(Intercept): 68.44611<br />year:  0.21886923<br />continent: Americas<br />country: Canada","(Intercept): 53.36402<br />year:  0.47684406<br />continent: Americas<br />country: Chile","(Intercept): 52.66561<br />year:  0.38075035<br />continent: Americas<br />country: Colombia","(Intercept): 58.29913<br />year:  0.40278951<br />continent: Americas<br />country: Costa Rica","(Intercept): 61.57115<br />year:  0.32115035<br />continent: Americas<br />country: Cuba","(Intercept): 47.65550<br />year:  0.47115245<br />continent: Americas<br />country: Dominican Republic","(Intercept): 48.06527<br />year:  0.50005315<br />continent: Americas<br />country: Ecuador","(Intercept): 45.55767<br />year:  0.47714126<br />continent: Americas<br />country: El Salvador","(Intercept): 41.05685<br />year:  0.53127343<br />continent: Americas<br />country: Guatemala","(Intercept): 38.45204<br />year:  0.39705804<br />continent: Americas<br />country: Haiti","(Intercept): 41.90671<br />year:  0.54285175<br />continent: Americas<br />country: Honduras","(Intercept): 62.21820<br />year:  0.22139441<br />continent: Americas<br />country: Jamaica","(Intercept): 52.10330<br />year:  0.45103497<br />continent: Americas<br />country: Mexico","(Intercept): 41.93209<br />year:  0.55651958<br />continent: Americas<br />country: Nicaragua","(Intercept): 57.35258<br />year:  0.35420909<br />continent: Americas<br />country: Panama","(Intercept): 62.16712<br />year:  0.15735455<br />continent: Americas<br />country: Paraguay","(Intercept): 43.29225<br />year:  0.52769790<br />continent: Americas<br />country: Peru","(Intercept): 66.52738<br />year:  0.21057483<br />continent: Americas<br />country: Puerto Rico","(Intercept): 61.70498<br />year:  0.17366154<br />continent: Americas<br />country: Trinidad and Tobago","(Intercept): 68.04551<br />year:  0.18416923<br />continent: Americas<br />country: United States","(Intercept): 65.37506<br />year:  0.18327203<br />continent: Americas<br />country: Uruguay","(Intercept): 56.85388<br />year:  0.32972168<br />continent: Americas<br />country: Venezuela"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(217,95,2,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(217,95,2,1)"}},"hoveron":"points","name":"Americas","legendgroup":"Americas","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[29.3566375291376,51.8141897435898,35.1392256410256,36.2236174825175,46.1290518321679,62.6966997668998,38.2591144522145,35.6138328671329,43.9857074592075,49.6430405594406,65.7661976689977,64.4162428904429,42.9204002331003,54.2727494172495,48.6167,56.6256606060606,58.1653002331003,50.5761731934732,42.949034032634,40.5453610722611,33.373117948718,35.6633855477855,42.9113769230769,48.5634076923077,39.5148692307692,61.1641125874126,59.3016983682984,44.9925631701632,60.6829463869464,51.9623265734266,37.6668461538462,42.5961960372961,28.9193631701632],"y":[0.275328671328671,0.467507692307692,0.498130769230769,0.395902797202797,0.530714853146853,0.365970629370629,0.505320979020979,0.634641258741258,0.49663986013986,0.235210489510489,0.267106293706294,0.352904195804195,0.57172937062937,0.316426573426573,0.5554,0.416836363636363,0.26102937062937,0.464522377622377,0.438688111888112,0.433095104895104,0.529261538461538,0.772179020979021,0.405792307692307,0.42046923076923,0.649623076923077,0.340886013986014,0.244894405594405,0.55435944055944,0.327244755244754,0.347048251748251,0.671615384615384,0.601100699300699,0.60545944055944],"text":["(Intercept): 29.35664<br />year:  0.27532867<br />continent: Asia<br />country: Afghanistan","(Intercept): 51.81419<br />year:  0.46750769<br />continent: Asia<br />country: Bahrain","(Intercept): 35.13923<br />year:  0.49813077<br />continent: Asia<br />country: Bangladesh","(Intercept): 36.22362<br />year:  0.39590280<br />continent: Asia<br />country: Cambodia","(Intercept): 46.12905<br />year:  0.53071485<br />continent: Asia<br />country: China","(Intercept): 62.69670<br />year:  0.36597063<br />continent: Asia<br />country: Hong Kong, China","(Intercept): 38.25911<br />year:  0.50532098<br />continent: Asia<br />country: India","(Intercept): 35.61383<br />year:  0.63464126<br />continent: Asia<br />country: Indonesia","(Intercept): 43.98571<br />year:  0.49663986<br />continent: Asia<br />country: Iran","(Intercept): 49.64304<br />year:  0.23521049<br />continent: Asia<br />country: Iraq","(Intercept): 65.76620<br />year:  0.26710629<br />continent: Asia<br />country: Israel","(Intercept): 64.41624<br />year:  0.35290420<br />continent: Asia<br />country: Japan","(Intercept): 42.92040<br />year:  0.57172937<br />continent: Asia<br />country: Jordan","(Intercept): 54.27275<br />year:  0.31642657<br />continent: Asia<br />country: Korea, Dem. Rep.","(Intercept): 48.61670<br />year:  0.55540000<br />continent: Asia<br />country: Korea, Rep.","(Intercept): 56.62566<br />year:  0.41683636<br />continent: Asia<br />country: Kuwait","(Intercept): 58.16530<br />year:  0.26102937<br />continent: Asia<br />country: Lebanon","(Intercept): 50.57617<br />year:  0.46452238<br />continent: Asia<br />country: Malaysia","(Intercept): 42.94903<br />year:  0.43868811<br />continent: Asia<br />country: Mongolia","(Intercept): 40.54536<br />year:  0.43309510<br />continent: Asia<br />country: Myanmar","(Intercept): 33.37312<br />year:  0.52926154<br />continent: Asia<br />country: Nepal","(Intercept): 35.66339<br />year:  0.77217902<br />continent: Asia<br />country: Oman","(Intercept): 42.91138<br />year:  0.40579231<br />continent: Asia<br />country: Pakistan","(Intercept): 48.56341<br />year:  0.42046923<br />continent: Asia<br />country: Philippines","(Intercept): 39.51487<br />year:  0.64962308<br />continent: Asia<br />country: Saudi Arabia","(Intercept): 61.16411<br />year:  0.34088601<br />continent: Asia<br />country: Singapore","(Intercept): 59.30170<br />year:  0.24489441<br />continent: Asia<br />country: Sri Lanka","(Intercept): 44.99256<br />year:  0.55435944<br />continent: Asia<br />country: Syria","(Intercept): 60.68295<br />year:  0.32724476<br />continent: Asia<br />country: Taiwan","(Intercept): 51.96233<br />year:  0.34704825<br />continent: Asia<br />country: Thailand","(Intercept): 37.66685<br />year:  0.67161538<br />continent: Asia<br />country: Vietnam","(Intercept): 42.59620<br />year:  0.60110070<br />continent: Asia<br />country: West Bank and Gaza","(Intercept): 28.91936<br />year:  0.60545944<br />continent: Asia<br />country: Yemen, Rep."],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(117,112,179,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(117,112,179,1)"}},"hoveron":"points","name":"Asia","legendgroup":"Asia","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[58.5597617715618,65.964476923077,67.4737538461539,57.3900536130536,65.4459300699301,63.4048631701632,67.2384461538462,70.7909296037296,65.9731240093241,67.3131254079254,67.1407617715618,66.5824079254079,65.7455226107226,71.6328386946387,67.1432223776224,66.0573738927739,61.6556254079254,71.616241958042,71.9507328671329,64.3884596736597,60.4723920745921,63.6473254079254,61.0240440559441,66.7417836829837,65.6852986013986,65.915958974359,71.2724909090909,69.009255011655,45.0278407925408,68.4365941724942],"y":[0.334683216783216,0.241992307692307,0.209084615384615,0.349755244755244,0.14568881118881,0.22545944055944,0.144815384615384,0.121330069930069,0.237925174825174,0.238501398601399,0.213683216783216,0.242398601398601,0.123648951048951,0.165375524475524,0.19911958041958,0.269710489510489,0.293001398601398,0.136686713286713,0.131941258741258,0.196218881118881,0.337201398601398,0.157401398601398,0.255151048951048,0.134044055944055,0.200523776223776,0.280930769230768,0.166254545454545,0.222231468531468,0.49723986013986,0.185965734265734],"text":["(Intercept): 58.55976<br />year:  0.33468322<br />continent: Europe<br />country: Albania","(Intercept): 65.96448<br />year:  0.24199231<br />continent: Europe<br />country: Austria","(Intercept): 67.47375<br />year:  0.20908462<br />continent: Europe<br />country: Belgium","(Intercept): 57.39005<br />year:  0.34975524<br />continent: Europe<br />country: Bosnia and Herzegovina","(Intercept): 65.44593<br />year:  0.14568881<br />continent: Europe<br />country: Bulgaria","(Intercept): 63.40486<br />year:  0.22545944<br />continent: Europe<br />country: Croatia","(Intercept): 67.23845<br />year:  0.14481538<br />continent: Europe<br />country: Czech Republic","(Intercept): 70.79093<br />year:  0.12133007<br />continent: Europe<br />country: Denmark","(Intercept): 65.97312<br />year:  0.23792517<br />continent: Europe<br />country: Finland","(Intercept): 67.31313<br />year:  0.23850140<br />continent: Europe<br />country: France","(Intercept): 67.14076<br />year:  0.21368322<br />continent: Europe<br />country: Germany","(Intercept): 66.58241<br />year:  0.24239860<br />continent: Europe<br />country: Greece","(Intercept): 65.74552<br />year:  0.12364895<br />continent: Europe<br />country: Hungary","(Intercept): 71.63284<br />year:  0.16537552<br />continent: Europe<br />country: Iceland","(Intercept): 67.14322<br />year:  0.19911958<br />continent: Europe<br />country: Ireland","(Intercept): 66.05737<br />year:  0.26971049<br />continent: Europe<br />country: Italy","(Intercept): 61.65563<br />year:  0.29300140<br />continent: Europe<br />country: Montenegro","(Intercept): 71.61624<br />year:  0.13668671<br />continent: Europe<br />country: Netherlands","(Intercept): 71.95073<br />year:  0.13194126<br />continent: Europe<br />country: Norway","(Intercept): 64.38846<br />year:  0.19621888<br />continent: Europe<br />country: Poland","(Intercept): 60.47239<br />year:  0.33720140<br />continent: Europe<br />country: Portugal","(Intercept): 63.64733<br />year:  0.15740140<br />continent: Europe<br />country: Romania","(Intercept): 61.02404<br />year:  0.25515105<br />continent: Europe<br />country: Serbia","(Intercept): 66.74178<br />year:  0.13404406<br />continent: Europe<br />country: Slovak Republic","(Intercept): 65.68530<br />year:  0.20052378<br />continent: Europe<br />country: Slovenia","(Intercept): 65.91596<br />year:  0.28093077<br />continent: Europe<br />country: Spain","(Intercept): 71.27249<br />year:  0.16625455<br />continent: Europe<br />country: Sweden","(Intercept): 69.00926<br />year:  0.22223147<br />continent: Europe<br />country: Switzerland","(Intercept): 45.02784<br />year:  0.49723986<br />continent: Europe<br />country: Turkey","(Intercept): 68.43659<br />year:  0.18596573<br />continent: Europe<br />country: United Kingdom"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(231,41,138,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(231,41,138,1)"}},"hoveron":"points","name":"Europe","legendgroup":"Europe","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null},{"x":[67.9450652680653,68.3012811188811],"y":[0.227723776223776,0.192820979020979],"text":["(Intercept): 67.94507<br />year:  0.22772378<br />continent: Oceania<br />country: Australia","(Intercept): 68.30128<br />year:  0.19282098<br />continent: Oceania<br />country: New Zealand"],"type":"scatter","mode":"markers","marker":{"autocolorscale":false,"color":"rgba(102,166,30,1)","opacity":1,"size":5.66929133858268,"symbol":"circle","line":{"width":1.88976377952756,"color":"rgba(102,166,30,1)"}},"hoveron":"points","name":"Oceania","legendgroup":"Oceania","showlegend":true,"xaxis":"x","yaxis":"y","hoverinfo":"text","frame":null}],"layout":{"margin":{"t":25.4977168949772,"r":7.30593607305936,"b":39.4520547945206,"l":43.1050228310502},"plot_bgcolor":"rgba(235,235,235,1)","paper_bgcolor":"rgba(255,255,255,1)","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[25.0010194055945,74.1864335081585],"tickmode":"array","ticktext":["30","40","50","60","70"],"tickvals":[30,40,50,60,70],"categoryorder":"array","categoryarray":["30","40","50","60","70"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"y","title":{"text":"Average Life Expectancy in 1950","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"yaxis":{"domain":[0,1],"automargin":true,"type":"linear","autorange":false,"range":[-0.136280979020979,0.815439020979021],"tickmode":"array","ticktext":["0.0","0.2","0.4","0.6","0.8"],"tickvals":[0,0.2,0.4,0.6,0.8],"categoryorder":"array","categoryarray":["0.0","0.2","0.4","0.6","0.8"],"nticks":null,"ticks":"outside","tickcolor":"rgba(51,51,51,1)","ticklen":3.65296803652968,"tickwidth":0.66417600664176,"showticklabels":true,"tickfont":{"color":"rgba(77,77,77,1)","family":"","size":11.689497716895},"tickangle":-0,"showline":false,"linecolor":null,"linewidth":0,"showgrid":true,"gridcolor":"rgba(255,255,255,1)","gridwidth":0.66417600664176,"zeroline":false,"anchor":"x","title":{"text":"Average Gain in Life Expectancy per Year","font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187}},"hoverformat":".2f"},"shapes":[{"type":"rect","fillcolor":null,"line":{"color":null,"width":0,"linetype":[]},"yref":"paper","xref":"paper","x0":0,"x1":1,"y0":0,"y1":1}],"showlegend":true,"legend":{"bgcolor":"rgba(255,255,255,1)","bordercolor":"transparent","borderwidth":1.88976377952756,"font":{"color":"rgba(0,0,0,1)","family":"","size":11.689497716895},"y":0.913385826771654},"annotations":[{"text":"continent","x":1.02,"y":1,"showarrow":false,"ax":0,"ay":0,"font":{"color":"rgba(0,0,0,1)","family":"","size":14.6118721461187},"xref":"paper","yref":"paper","textangle":-0,"xanchor":"left","yanchor":"bottom","legendTitle":true}],"hovermode":"closest","barmode":"relative"},"config":{"doubleClick":"reset","showSendToCloud":false},"source":"A","attrs":{"109a74e2d03e3":{"x":{},"y":{},"colour":{},"label":{},"type":"scatter"}},"cur_data":"109a74e2d03e3","visdat":{"109a74e2d03e3":["function (y) ","x"]},"highlight":{"on":"plotly_click","persistent":false,"dynamic":false,"selectize":false,"opacityDim":0.2,"selected":{"opacity":1},"debounce":0},"shinyEvents":["plotly_hover","plotly_click","plotly_selected","plotly_relayout","plotly_brushed","plotly_brushing","plotly_clickannotation","plotly_doubleclick","plotly_deselect","plotly_afterplot"],"base_url":"https://plot.ly"},"evals":[],"jsHooks":[]}</script>


---
# Life Expectancy in the U.S.

Start with a single country, then generalize over all countries: 


```r
usa &lt;- gapminder %&gt;% filter(country=="United States")
head(usa)
# A tibble: 6 x 6
  country       continent  year lifeExp       pop gdpPercap
  &lt;fct&gt;         &lt;fct&gt;     &lt;int&gt;   &lt;dbl&gt;     &lt;int&gt;     &lt;dbl&gt;
1 United States Americas   1952    68.4 157553000    13990.
2 United States Americas   1957    69.5 171984000    14847.
3 United States Americas   1962    70.2 186538000    16173.
4 United States Americas   1967    70.8 198712000    19530.
5 United States Americas   1972    71.3 209896000    21806.
6 United States Americas   1977    73.4 220239000    24073.
```

---
# Life Expectancy in the U.S. since 1950


```r
ggplot(data=usa, aes(x=year, y=lifeExp)) + 
  geom_point() +
  geom_smooth(method="lm")
```

&lt;img src="index_files/figure-html/unnamed-chunk-18-1.png" style="display: block; margin: auto;" /&gt;

---
# Life Expectancy in the U.S. since 1950


```r
usa.lm &lt;- lm(lifeExp~year, data=usa)
usa.lm

Call:
lm(formula = lifeExp ~ year, data = usa)

Coefficients:
(Intercept)         year  
  -291.0845       0.1842  
```

Intercept is estimated life expectancy at 0 BC - let's use 1950 for the first value:


```r
gapminder &lt;- gapminder %&gt;% mutate(year = year-1950)
```

---
# Nesting data

We don't want to subset the data for every country ... 

`nest()` makes a data frame part of another data frame:


```r
by_country &lt;- gapminder %&gt;% group_by(continent, country) %&gt;% nest()
head(by_country)
# A tibble: 6 x 3
  continent country     data             
  &lt;fct&gt;     &lt;fct&gt;       &lt;list&gt;           
1 Asia      Afghanistan &lt;tibble [12 × 4]&gt;
2 Europe    Albania     &lt;tibble [12 × 4]&gt;
3 Africa    Algeria     &lt;tibble [12 × 4]&gt;
4 Africa    Angola      &lt;tibble [12 × 4]&gt;
5 Americas  Argentina   &lt;tibble [12 × 4]&gt;
6 Oceania   Australia   &lt;tibble [12 × 4]&gt;
```

Each element of the `data` variable in `by_country` is a dataset.

We will fit a linear model to each one of the elements of the `by_country` data.


---
# Fitting multiple models

Now we are using the `map` function in the package `purrr`.

`map` allows us to apply a function to each element of a list.


```r
by_country$model &lt;- by_country$data %&gt;% purrr::map(~lm(lifeExp~year, data=.))
head(by_country)
# A tibble: 6 x 4
  continent country     data              model 
  &lt;fct&gt;     &lt;fct&gt;       &lt;list&gt;            &lt;list&gt;
1 Asia      Afghanistan &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
2 Europe    Albania     &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
3 Africa    Algeria     &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
4 Africa    Angola      &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
5 Americas  Argentina   &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
6 Oceania   Australia   &lt;tibble [12 × 4]&gt; &lt;lm&gt;  
```

---
# `broom` again

using `broom::tidy` we extract coefficients for each model


```r
broom::tidy(by_country$model[[1]])
# A tibble: 2 x 5
  term        estimate std.error statistic  p.value
  &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
1 (Intercept)   29.4      0.699       42.0 1.40e-12
2 year           0.275    0.0205      13.5 9.84e- 8
```

---
# Extract values for each coefficient

Extract all countries automatically (hello `map` again!)


```r
by_country$coefs &lt;- by_country$model %&gt;% purrr::map(broom::tidy)
by_country
# A tibble: 142 x 5
   continent country     data              model  coefs           
   &lt;fct&gt;     &lt;fct&gt;       &lt;list&gt;            &lt;list&gt; &lt;list&gt;          
 1 Asia      Afghanistan &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 2 Europe    Albania     &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 3 Africa    Algeria     &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 4 Africa    Angola      &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 5 Americas  Argentina   &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 6 Oceania   Australia   &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 7 Europe    Austria     &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 8 Asia      Bahrain     &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
 9 Asia      Bangladesh  &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
10 Europe    Belgium     &lt;tibble [12 × 4]&gt; &lt;lm&gt;   &lt;tibble [2 × 5]&gt;
# … with 132 more rows
```

---
# Get the coefficients into one data set

`unnest` pulls little data frames back into the whole frame


```r
by_country_coefs &lt;- by_country %&gt;% unnest(coefs)
by_country_coefs
# A tibble: 284 x 7
   continent country     term        estimate std.error statistic  p.value
   &lt;fct&gt;     &lt;fct&gt;       &lt;chr&gt;          &lt;dbl&gt;     &lt;dbl&gt;     &lt;dbl&gt;    &lt;dbl&gt;
 1 Asia      Afghanistan (Intercept)   29.4     0.699       42.0  1.40e-12
 2 Asia      Afghanistan year           0.275   0.0205      13.5  9.84e- 8
 3 Europe    Albania     (Intercept)   58.6     1.13        51.7  1.79e-13
 4 Europe    Albania     year           0.335   0.0332      10.1  1.46e- 6
 5 Africa    Algeria     (Intercept)   42.2     0.756       55.8  8.22e-14
 6 Africa    Algeria     year           0.569   0.0221      25.7  1.81e-10
 7 Africa    Angola      (Intercept)   31.7     0.804       39.4  2.63e-12
 8 Africa    Angola      year           0.209   0.0235       8.90 4.59e- 6
 9 Americas  Argentina   (Intercept)   62.2     0.167      372.   4.80e-22
10 Americas  Argentina   year           0.232   0.00489     47.4  4.22e-13
# … with 274 more rows
```

---
# ... and finally, a visualization:


```r
coefs &lt;- by_country_coefs %&gt;% 
  select(country, continent, term, estimate) %&gt;% 
  spread(term, estimate)
ggplot(data=coefs, aes(x=`(Intercept)`, y=year, colour=continent)) +
  geom_point()
```

&lt;img src="index_files/figure-html/unnamed-chunk-26-1.png" style="display: block; margin: auto;" /&gt;

---
class: inverse middle 
# Your turn



- use `broom::glance` to get model fits for each one of the linear models of life expectancy by year
- which countries have the best five fits? which countries have the worst fits?
- are there meaningful patterns?




---
class: inverse middle 
# Your turn


- extract residuals for each of the models and store it in a dataset together with country and continent information
- plot residuals across the years and fit a smooth. What does the pattern mean?




---
# References

- Ian Lyttle's notes on using [purrr ](http://ijlyttle.github.io/isugg_purrr/presentation.html#(1)
- RStudio's tutorial by Charlotte Wickham on using [purrr](https://www.rstudio.com/resources/videos/happy-r-users-purrr-tutorial/)
- [R blogger's article on purrr](http://www.r-bloggers.com/purrr-0-1-0/)
- [RStudio cheatsheets](https://www.rstudio.com/resources/cheatsheets/)
- [Wickham (2007) Reshaping data](https://www.jstatsoft.org/article/view/v021i12)
- [broom vignettes, David Robinson](https://cran.r-project.org/web/packages/broom/vignettes/broom.html)
- [Wickham (2011) Split-Apply-Combine](https://www.jstatsoft.org/article/view/v040i01)

---
# Share and share alike

&lt;a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;&lt;img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /&gt;&lt;/a&gt;&lt;br /&gt;This work is licensed under a &lt;a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"&gt;Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License&lt;/a&gt;.
    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();</script>

<script>
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
