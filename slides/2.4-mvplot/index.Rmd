---
title: "Multivariate data plots"
subtitle: "SISBID 2024 <br> https://github.com/dicook/SISBID"
author: "Di Cook (dicook@monash.edu) <br> Heike Hofmann (hhofmann4@unl.edu) <br> Susan Vanderplas (susan.vanderplas@unl.edu) "
date: "08/14-16/2024"
output:
  xaringan::moon_reader:
    css: ["default", "myremark.css"]
    self_contained: false
    nature:
      ratio: '16:9'
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
---

```{r echo = FALSE}
knitr::opts_chunk$set(
  echo=TRUE, 
  message = FALSE,
  warning = FALSE,
  error = FALSE,
  collapse = TRUE,
  comment = "",
  fig.height = 4,
  fig.width = 8,
  fig.align = "center",
  fig.retina = 3,
  cache = FALSE
)
```

```{r echo=FALSE}
#library(tidyverse)
library(tidyr)
library(dplyr)
library(ggplot2)
library(readr)
library(lubridate)
library(GGally)
library(tourr)
library(broom)
library(plotly)
library(palmerpenguins)
```

class: inverse middle 
# Your turn 

- What is multivariate data?
- What makes multivariate analysis different from univariate analysis?


```{r echo=FALSE}
countdown::countdown(1,0)
```

???

- data is multivariate, if we have more information than a single aspect for each entity/person/experimental unit.
- multivariate analysis takes relationships between these different aspects into account.


---
# Main types of plots

- __pairwise plots__: explore association between pairs of variables
- __parallel coordinate plots__: use parallel axes to lay out many variables on a page
- __heatmaps__: represent data value using colour, present as a coloured table
- __tours__: sequence of projections of high-dimensional data, good for examining shape and distribution between many variables

---
# Scatterplot matrix: GGally

.pull-left[The basic plot plot for multivariate data is a scatterplot matrix. There are two functions available in the GGally package: `ggpairs`.

```{r scatterplot matrix, fig.show='hide'}
# Make a simple scatterplot matrix of the new penguins data
penguins <- penguins %>% filter(!is.na(bill_length_mm)) 
ggpairs(penguins, columns=c(3:6))
```

*What do we learn?*

- clustering
- linear dependence
]
.pull-right[
```{r ref.label="scatterplot matrix", echo=FALSE, fig.width=6, fig.height=6}
```
]

---

.pull-left[
**Add some colour for groups**

```{r scatterplot matrix with colour, echo=TRUE, fig.show='hide'}
# Re-make mapping colour to species (class)
ggpairs(penguins, columns=c(3:6), 
        ggplot2::aes(colour=species))
```

<br>
<br>
<br>
*What do we learn?*

- clustering is due to the class variable
]
.pull-right[
```{r ref.label="scatterplot matrix with colour", echo=FALSE, fig.width=6, fig.height=6}
```
]

---

.pull-left[
Only show correlation. `r anicon::nia("This is dangerous!", animate="float")` Only appropriate if correlation is a good summary of the association.

```{r correlation heatmap, echo=TRUE, fig.show='hide'}
# Look at one species only
adelie <- penguins %>% 
  filter(species == "Adelie") %>%
  select(bill_length_mm:body_mass_g)
ggcorr(adelie)
```

]
.pull-right[
```{r ref.label="correlation heatmap", echo=FALSE, fig.width=4, fig.height=4, out.width="90%"}
```
]

---

.pull-left[
Only show correlation, using a corrgram. Again, this is dangerous, and only useful to get a broad overview of association that is suitably summarised by correlation.

```{r corrgram, echo=TRUE, fig.show='hide'}
# install.packages("corrgram")
library(corrgram)
corrgram(adelie, 
  lower.panel=corrgram::panel.ellipse)
```

The `corrgram` package has numerous scatterplot matrix capabilities.

]
.pull-right[
```{r ref.label="corrgram", echo=FALSE, fig.width=4, fig.height=4, out.width="90%"}
```
]


---
# Generalized pairs plot

.pull-left[
The pairs plot can also incorporate non-numerical variables, and different types of two variable plots.

```{r generalised pairs plot, fig.show='hide'}
# Matrix plot when variables are not numeric
data(australia_PISA2012)
australia_PISA2012 <- australia_PISA2012 %>%
  mutate(desk = factor(desk), 
         room = factor(room),
         study = factor(study), 
         computer = factor(computer),
         software = factor(software), 
         internet = factor(internet),
         literature = factor(literature), 
         poetry= factor(poetry),
         art = factor(art), 
         textbook = factor(textbook),
         dictionary = factor(dictionary),
         dishwasher = factor(dishwasher))
australia_PISA2012 %>% 
  filter(!is.na(dishwasher)) %>% 
  ggpairs(columns=c(3, 15, 16, 21, 26))
```
]
.pull-right[
```{r ref.label='generalised pairs plot', echo=FALSE, fig.width=6, fig.height=6, out.width="90%"}
```
]

---

```{r generalised pairs plot enhance plots, echo=TRUE, fig.width=6, fig.height=6}
# Modify the defaults, set the transparency of points since there is a lot of data
australia_PISA2012 %>% 
  filter(!is.na(dishwasher)) %>% 
  ggpairs(columns=c(3, 15, 16, 21, 26), 
          lower = list(continuous = wrap("points", alpha=0.05)))
```

---

.pull-left[
```{r design own plot function}
# Make a special style of plot to put in the matrix
my_fn <- function(data, mapping, method="loess", ...){
      p <- ggplot(data = data, mapping = mapping) + 
      geom_point(alpha=0.2, size=1) + 
      geom_smooth(method="lm", ...)
      p
}
```

```{r generalised pairs plot enhance more, echo=TRUE, fig.show='hide'}
australia_PISA2012 %>% 
  filter(!is.na(dishwasher)) %>% 
  ggpairs(columns=c(3, 15, 16, 21, 26), 
          lower = list(continuous = my_fn))

```

*What do we learn?*

- moderate increase in all scores as more time is spent on homework
- test scores all have a very regular bivariate normal shape - is this simulated data? yes.
- having a dishwasher in the household corresponds to small increase in homework time
- very little but slight increase in scores with a dishwasher in household

]
.pull-right[
```{r ref.label='generalised pairs plot enhance more', echo=FALSE, fig.width=6, fig.height=6, outwidth="90%"}
australia_PISA2012 %>% 
  filter(!is.na(dishwasher)) %>% 
  ggpairs(columns=c(3, 15, 16, 21, 26), 
          lower = list(continuous = my_fn))

```
]

---
class: inverse middle

# Your turn

Re-make the plot with 

- side-by-side boxplots on the lower triangle, for the combo variables, 
- and the density plots in the upper triangle.

```{r echo=FALSE}
countdown::countdown(8,0)
```

```{r echo=FALSE, eval=FALSE}
australia_PISA2012 %>% 
  filter(!is.na(dishwasher)) %>% 
  ggpairs(columns=c(3, 15, 16, 21, 26), 
          lower = list(combo = "box_no_facet"),
          upper = list(continuous = "density"))
```

---
# Regression setting

.pull-left[
An alternative pairs plot that better matches this sort of data, where there is a response variable and explanatory variables. For this data, plot house price against all other variables.

```{r wrangle housing data}
housing <- read_csv(here::here("data/housing.csv")) %>%
  mutate(date = dmy(date)) %>%
  mutate(year = year(date)) %>%
  filter(year == 2016) %>%
  filter(!is.na(bedroom2), !is.na(price)) %>%
  filter(bedroom2 < 7, bathroom < 5) %>%
  mutate(bedroom2 = factor(bedroom2), 
         bathroom = factor(bathroom)) 
```
]
.pull-right[
```{r make a regression style pairs plot, out.width="100%", fig.width=8, fig.height=3}
ggduo(housing[, c(4,3,8,10,11)], 
      columnsX = 2:5, columnsY = 1, 
      aes(colour=type, fill=type), 
      types = list(continuous = 
                     wrap("smooth", 
                       alpha = 0.10)))
```
]

---
# Big biological data

The Bioconductor package `bigPint` has tools for working with larger amounts of data, as seen in RNA-Seq experiments. More info at https://lindsayrutter.github.io/bigPint/

```{r eval=FALSE, echo=FALSE}
if (!requireNamespace("BiocManager", quietly = TRUE))
    install.packages("BiocManager")
BiocManager::install("bigPint")
```

.pull-left[

Data on soybean experiment, with two treatments, and three replicates. Here's the scatterplot of the first replicate. 

```{r soybean_scat, fig.show='hide', eval=FALSE}
# if (!require("BiocManager", quietly = TRUE))
#    install.packages("BiocManager")
# BiocManager::install("bigPint")
library(bigPint) 
data(soybean_ir_sub)
soybean_ir_sub[,-1] <- log(soybean_ir_sub[,-1]+1)
ggplot(soybean_ir_sub, 
       aes(x=N.1, y=P.1)) + 
  geom_point() + 
  theme(aspect.ratio=1)
```
]

.pull-right[

```{r ref.label='soybean_scat', fig.width=4, fig.height=4, out.width="90%", echo=FALSE, eval=FALSE}
```
]

---

The `litre` plot combines replicates into same plot, to look at the treatments. To handle the data size it uses a hexbin display. The data values for an individual gene can be overlaid on the plot.

.pull-left[
```{r soybean_litre, fig.show='hide', eval=FALSE}
geneList = soybean_ir_sub_metrics[["N_P"]][1:5,]$ID
ret <- plotLitre(data = soybean_ir_sub, 
                 geneList = geneList, 
                 pointColor = "deeppink")
names(ret)
ret[["N_P_Glyma.19G168700.Wm82.a2.v1"]]
```
]

.pull-right[
```{r ref.label='soybean_litre', fig.width=6, fig.height=6, out.width="90%", echo=FALSE, results='hide', eval=FALSE}
```
]

---

.pull-left[
This can be extended into a scatterplot matrix

```{r soybean_litre_sm, fig.show='hide', eval=FALSE}
ret <- plotSM(soybean_cn_sub, 
              soybean_cn_sub_metrics, 
              option = "hexagon", 
              xbins = 5, 
              pointSize = 0.1, 
              saveFile = FALSE, eval=FALSE)
ret[[2]]
```
]
.pull-right[
```{r ref.label='soybean_litre_sm', fig.width=6, fig.height=6, out.width="110%", echo=FALSE, results='hide', eval=FALSE}
```
]

---

.pull-left[
When working with RNA-Seq data, it is useful to compare samples using a side-by-side boxplot. Overlaying the profiles of different genes can help to learn about the patterns across samples, particularly to examine the significant genes after testing. (This can be called a parallel coordinate plot.)

```{r soybean_pcp, fig.show='hide', eval=FALSE}
ret <- plotPCP(data = soybean_ir_sub, 
               geneList = geneList, 
               lineSize = 0.3, 
               saveFile = FALSE)
ret[[1]]
```
]
.pull-right[
```{r ref.label='soybean_pcp', fig.width=6, fig.height=6, out.width="90%", echo=FALSE, results='hide', eval=FALSE}
```
]

---
# Resources

- [GGobi web site](http://www.ggobi.org), [ggobi book](http://www.ggobi.org/book)
- Emerson et al (2013) The Generalized Pairs Plot, Journal of Computational and Graphical Statistics, 22:1, 79-91
- [Natalia da Silva](http://natydasilva.com/) [PPForest](https://cran.r-project.org/web/packages/PPforest/index.html) and [shiny app](https://natydasilva.shinyapps.io/shinyV03/).
- Eunkyung Lee [PPtreeViz](https://www.jstatsoft.org/article/view/v083i08)
- Wickham, Cook, Hofmann (2015) [Visualising Statistical Models: Removing the blindfold](http://dicook.org/publication/blindfold_2015/)
- Cook and Swayne (2007) [Interactive and Dynamic Graphics for Data Analysis](http://ggobi.org/book/)
- Wickham et al (2011) [tourr: An R Package for Exploring Multivariate Data with Projections](https://www.jstatsoft.org/article/view/v040i02/v40i02.pdf) and the R package [tourr](https://cran.r-project.org/web/packages/tourr/index.html)
- Schloerke et al (2016) [Escape from Boxland](https://journal.r-project.org/archive/2016/RJ-2016-044/index.html), [the web site zoo](http://schloerke.com/geozoo/) and the R package [geozoo](https://cran.r-project.org/web/packages/geozoo/index.html)

---
# Share and share alike

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.
